---
platform: linux

image_resource:
  type: docker-image
  source: { repository: hub.***REMOVED***/monsoon/alpinebuild, tag: '3.4' }

inputs:
  - name: mosquitto.git 

outputs:
  - name: build

run:
  path: sh
  args:
    - -exc
    - |
      #prepare
      export REPODEST=$PWD/packages
      mkdir $REPODEST
      echo "$REPODEST/mosquitto.git" >> /etc/apk/repositories
      chown build $REPODEST

      chown build mosquitto.git/mosquitto
      build-package mosquitto.git/mosquitto

      chown build  mosquitto.git/mosquitto-auth-monsoon 
      build-package  mosquitto.git/mosquitto-auth-monsoon

      # copy to task output
      git clone mosquitto.git build/
      cp -r $REPODEST/mosquitto.git build/packages
      cp /home/build/.abuild/*.pub build/packages/

