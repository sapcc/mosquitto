# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=mosquitto
pkgver=1.4.9
pkgrel=0
pkgdesc="An Open Source MQTT v3.1 Broker"
url="http://mosquitto.org/"
arch="all"
license="BSD"
depends=""
depends_dev=""
makedepends="$depends_dev openssl-dev c-ares-dev util-linux-dev
	libwebsockets-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-libs++:_pp
	$pkgname-libs $pkgname-clients"
replaces="mosquitto-utils"
source="http://mosquitto.org/files/source/mosquitto-$pkgver.tar.gz
	mosquitto.initd
  0001-subject-as-username.patch
  0002-log-rfc3339-timestamp.patch"

_builddir="$srcdir"/mosquitto-$pkgver
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	sed -i "s|prefix=/usr/local|prefix=/usr|" config.mk
	# dont strip
	sed -i -e "s|(INSTALL) -s|(INSTALL)|g" \
		-e 's|--strip-program=${CROSS_COMPILE}${STRIP}||' \
		*/Makefile */*/Makefile
}

build() {
	cd "$_builddir"
	make \
		WITH_MEMORY_TRACKING=no \
		WITH_WEBSOCKETS=yes \
		WITH_SRV=yes \
		prefix=/usr || return 1
}

package() {
	cd "$_builddir"
	make prefix=/usr DESTDIR="$pkgdir" install || return 1
	mv "$pkgdir"/etc/mosquitto/mosquitto.conf.example \
		"$pkgdir"/etc/mosquitto/mosquitto.conf || return 1
	sed -i -e 's/#log_dest stderr/log_dest syslog/' \
		"$pkgdir"/etc/mosquitto/mosquitto.conf || return 1
	install -Dm755 "$srcdir"/mosquitto.initd "$pkgdir"/etc/init.d/mosquitto
}

_pp() {
	pkgdesc="C++ wrapper for libmosquitto"
	replaces=
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libmosquittopp.so.* "$subpkgdir"/usr/lib/
}

clients() {
	pkgdesc="Mosquitto command line MQTT clients"
	replaces="mosquitto-utils"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/mosquitto_[ps]ub "$subpkgdir"/usr/bin/
}

md5sums="67943e2c5afebf7329628616eb2c41c5  mosquitto-1.4.9.tar.gz
3a5c35f76efabcb7bd4fb6398caf9e5b  mosquitto.initd
ef197246e697ba4675b91bd75ff167d4  0001-subject-as-username.patch
4d5837af997eb41774f2dfc8609bd078  0002-log-rfc3339-timestamp.patch"
sha256sums="1df3ae07de40b80a74cd37a7b026895c544cdd3b42c9e0719ae91623aa98c58b  mosquitto-1.4.9.tar.gz
97c7324f0f5e9dce52b241366bcfc3fb02ef8d2e0d622bab898eb36f261056c9  mosquitto.initd
305f59db9e3977efe828474a2b43a88d381372b01a991f9142250ab49a68fd71  0001-subject-as-username.patch
32c1e754fa33a31bf5bf4286ff4e5c6f70e76f824e2fae5ba558451c1baa53af  0002-log-rfc3339-timestamp.patch"
sha512sums="5994159d9a8da248a877f3032f36ca9a865d9b4efaafac329620864049992a77d414e02252cbbfef89ea2c37dc761b1885a89e19fc8e82b2a42d38f31e761d4d  mosquitto-1.4.9.tar.gz
16f96d8f7f3a8b06e2b2e04d42d7e0d89a931b52277fc017e4802f7a3bc85aff4dd290b1a0c40382ea8f5568d0ceb7319c031d9be916f346d805231a002b0433  mosquitto.initd
2f6839e49123a488942254b33f6259ac8b3dcc5816d76501ea7642c61623893bcac68c3034d8219b3209b82afc9f64a7a0a54bf2a52b25090407b540e0365f63  0001-subject-as-username.patch
8a50c6c843724ab2b36e2030301cea5a0fe1b42f1bba46eb56170102295352de053de640a4f4859e30ec38d1d6ada64cc9be84edb0b129f3b515c48b11f1ebe4  0002-log-rfc3339-timestamp.patch"
